<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    
    <!-- iOS Meta Tags for Fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dr. Deepak">
    
    <!-- Android/Chrome Meta Tags for Fullscreen -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#001b3a">
    <meta name="color-scheme" content="dark">
    
    <!-- Prevents Chrome from showing the mini-infobar -->
    <meta name="format-detection" content="telephone=no">
    
    <title>Dr. Deepak | NeuraScaleX</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-192.png">
    
    <style>
        /* Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #001b3a;
            color: #ffffff;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile browsers */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Force hide address bar on scroll */
            -webkit-overflow-scrolling: touch;
        }

        /* Additional body styles to prevent scrolling */
        html {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        /* Prevent pull-to-refresh in Chrome */
        body {
            overscroll-behavior-y: contain;
            touch-action: pan-y;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #001b3a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .splash-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }

        /* Safety Net Background Layer */
        #safety-net {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #001b3a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            z-index: 1;
        }

        #safety-net.hidden {
            display: none;
        }

        .safety-logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
            margin-bottom: 16px;
            animation: pulse 3s ease-in-out infinite;
        }

        .safety-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 48px;
            text-align: center;
            line-height: 1.5;
        }

        .reopen-button {
            background: linear-gradient(135deg, #C5A059 0%, #B8934D 100%);
            color: #001b3a;
            border: none;
            border-radius: 50px;
            padding: 18px 48px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(197, 160, 89, 0.3);
            -webkit-appearance: none;
            appearance: none;
        }

        .reopen-button:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(197, 160, 89, 0.4);
        }

        .security-badge {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0.5px;
        }

        /* Widget Container */
        #widget-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            z-index: 1000;
            overflow: hidden;
        }

        /* Force widget to be fullscreen */
        #widget-container iframe,
        #widget-container > div {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            height: 100dvh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            border: none !important;
            border-radius: 0 !important;
        }

        /* Hide any widget launcher buttons */
        button[class*="launcher"],
        button[class*="trigger"],
        div[class*="launcher"],
        div[class*="trigger"] {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-logo">NeuraScaleX</div>
        <div class="splash-text">Initializing Secure Environment...</div>
    </div>

    <!-- Safety Net Background -->
    <div id="safety-net">
        <div class="safety-logo">NeuraScaleX</div>
        <div class="safety-subtitle">Your Digital Clinical Companion</div>
        <button class="reopen-button" onclick="reopenChat()">OPEN DIGITAL TWIN</button>
        <div class="security-badge">
            ðŸ”’ Secure Clinical Environment
        </div>
    </div>

    <!-- Widget Container -->
    <div id="widget-container"></div>

    <script>
        // Session Sanitization - Clear localStorage on every load
        try {
            localStorage.clear();
            console.log('Session sanitized - localStorage cleared');
        } catch (e) {
            console.warn('Could not clear localStorage:', e);
        }

        // Configuration
        const CONFIG = {
            widgetCheckInterval: 100, // Check every 100ms
            maxWaitTime: 10000, // Wait up to 10 seconds
            splashMinDuration: 2000, // Minimum splash screen duration
            autoOpenDelay: 500 // Delay before auto-opening
        };

        let widgetCheckTimer = null;
        let widgetOpened = false;
        const startTime = Date.now();

        // Function to open the chat widget
        function openNexusChat() {
            if (widgetOpened) return;

            // Try multiple selectors to find the widget launcher
            const selectors = [
                'button[class*="launcher"]',
                'button[class*="trigger"]',
                'div[class*="launcher"]',
                'div[class*="trigger"]',
                '[data-widget-launcher]',
                '#nexus-chat-launcher',
                '.chat-launcher',
                '.widget-launcher'
            ];

            for (const selector of selectors) {
                const launcher = document.querySelector(selector);
                if (launcher && launcher.click) {
                    console.log('Widget launcher found, opening chat...');
                    launcher.click();
                    widgetOpened = true;
                    
                    // Hide safety net once widget opens
                    setTimeout(() => {
                        document.getElementById('safety-net').classList.add('hidden');
                    }, 500);
                    
                    return true;
                }
            }

            return false;
        }

        // Function to manually reopen chat
        function reopenChat() {
            widgetOpened = false;
            document.getElementById('safety-net').classList.add('hidden');
            
            // Try to open immediately
            if (!openNexusChat()) {
                // If not found, restart the check timer
                startWidgetMonitoring();
            }
        }

        // Monitor for widget readiness
        function startWidgetMonitoring() {
            if (widgetCheckTimer) {
                clearInterval(widgetCheckTimer);
            }

            widgetCheckTimer = setInterval(() => {
                const elapsed = Date.now() - startTime;

                // Try to open the widget
                if (openNexusChat()) {
                    clearInterval(widgetCheckTimer);
                    hideSplashScreen();
                    return;
                }

                // Stop checking after max wait time
                if (elapsed > CONFIG.maxWaitTime) {
                    console.warn('Widget not found after max wait time');
                    clearInterval(widgetCheckTimer);
                    hideSplashScreen();
                    document.getElementById('safety-net').classList.remove('hidden');
                }
            }, CONFIG.widgetCheckInterval);
        }

        // Hide splash screen
        function hideSplashScreen() {
            const elapsed = Date.now() - startTime;
            const remainingTime = Math.max(0, CONFIG.splashMinDuration - elapsed);

            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.classList.add('fade-out');
                setTimeout(() => {
                    splash.remove();
                }, 500);
            }, remainingTime);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PWA Wrapper initialized');
            
            // Force fullscreen mode and hide address bar
            initializeFullscreen();
            
            // Start monitoring for widget after a brief delay
            setTimeout(() => {
                startWidgetMonitoring();
            }, CONFIG.autoOpenDelay);
        });

        // Function to hide address bar and force fullscreen
        function initializeFullscreen() {
            // Method 1: Scroll to hide address bar (works in Chrome/Safari)
            window.scrollTo(0, 1);
            
            // Method 2: Request fullscreen if supported (Android Chrome)
            if (document.documentElement.requestFullscreen) {
                // We can't auto-request fullscreen, but we can prepare for it
                // User can manually trigger with gesture
            }
            
            // Method 3: Set viewport height after a delay to account for address bar
            setTimeout(() => {
                // Force recalculation of viewport height
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Apply to body
                document.body.style.height = `${window.innerHeight}px`;
            }, 100);
            
            // Update viewport height on orientation change
            window.addEventListener('resize', () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                document.body.style.height = `${window.innerHeight}px`;
            });
            
            // Prevent rubber-band scrolling (iOS Safari)
            document.addEventListener('touchmove', (e) => {
                if (e.target === document.body) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Handle visibility changes (user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !widgetOpened) {
                console.log('Page visible again, checking for widget...');
                startWidgetMonitoring();
            }
        });

        // PWA Installation prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA installation available');
        });

        // TODO: Load your NeuraScaleX widget script here
        // Example:
        // const script = document.createElement('script');
        // script.src = 'https://your-widget-url.com/widget.js';
        // script.async = true;
        // script.setAttribute('data-config', JSON.stringify({
        //     autoOpen: false,
        //     clientId: 'YOUR_AZURE_CLIENT_ID',
        //     // ... other config
        // }));
        // document.head.appendChild(script);
    </script>
</body>
</html>